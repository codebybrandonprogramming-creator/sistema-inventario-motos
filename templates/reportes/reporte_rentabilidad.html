{% extends "base.html" %}

{% block title %}Reporte de Rentabilidad{% endblock %}

{% block content %}
<div class="container">
    <div class="header-section">
        <h1>üìà Reporte de Productos M√°s Rentables</h1>
        <div class="button-group">
            <a href="{{ url_for('exportar_rentabilidad_excel', **request.args) }}" class="btn btn-success">
                üìä Exportar a Excel
            </a>
            <a href="{{ url_for('dashboard') }}" class="btn btn-secondary">‚Üê Volver al Dashboard</a>
        </div>
    </div>

    <!-- Filtros -->
    <div class="filter-section">
        <form method="GET" class="filter-form">
            <div class="filter-group">
                <label>Fecha Desde:</label>
                <input type="date" name="fecha_desde" value="{{ request.args.get('fecha_desde', '') }}" class="form-control">
            </div>
            <div class="filter-group">
                <label>Fecha Hasta:</label>
                <input type="date" name="fecha_hasta" value="{{ request.args.get('fecha_hasta', '') }}" class="form-control">
            </div>
            <div class="filter-group">
                <label>Ordenar por:</label>
                <select name="ordenar" class="form-control">
                    <option value="ganancia" {% if request.args.get('ordenar') != 'cantidad' %}selected{% endif %}>Mayor Ganancia</option>
                    <option value="cantidad" {% if request.args.get('ordenar') == 'cantidad' %}selected{% endif %}>M√°s Vendido</option>
                </select>
            </div>
            <div class="filter-group">
                <button type="submit" class="btn btn-info">üîç Filtrar</button>
                <a href="{{ url_for('reporte_rentabilidad') }}" class="btn btn-secondary">Limpiar</a>
            </div>
        </form>
    </div>

    <!-- Cards de Resumen -->
    <div class="summary-cards">
        <div class="summary-card green">
            <div class="summary-icon">üí∞</div>
            <div class="summary-content">
                <h3>Ganancia Total</h3>
                <p>${{ "{:,.2f}".format(ganancia_total) }}</p>
            </div>
        </div>
        <div class="summary-card blue">
            <div class="summary-icon">üì¶</div>
            <div class="summary-content">
                <h3>Productos Vendidos</h3>
                <p>{{ total_productos }} tipos</p>
            </div>
        </div>
        <div class="summary-card orange">
            <div class="summary-icon">üî¢</div>
            <div class="summary-content">
                <h3>Unidades Vendidas</h3>
                <p>{{ unidades_vendidas }}</p>
            </div>
        </div>
    </div>

    <!-- TOP 10 Productos M√°s Rentables -->
    <div class="table-card">
        <h3>üèÜ TOP 10 Productos M√°s Rentables</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>#</th>
                    <th>Producto</th>
                    <th>Categor√≠a</th>
                    <th>Unidades Vendidas</th>
                    <th>Total Vendido</th>
                    <th>Ganancia Unitaria</th>
                    <th>Ganancia Total</th>
                    <th>% Margen</th>
                </tr>
            </thead>
            <tbody>
                {% if productos_rentables %}
                    {% for producto in productos_rentables[:10] %}
                    <tr class="{% if loop.index <= 3 %}top-product{% endif %}">
                        <td class="rank">
                            {% if loop.index == 1 %}ü•á
                            {% elif loop.index == 2 %}ü•à
                            {% elif loop.index == 3 %}ü•â
                            {% else %}{{ loop.index }}
                            {% endif %}
                        </td>
                        <td><strong>{{ producto.nombre }}</strong></td>
                        <td>{{ producto.categoria }}</td>
                        <td class="text-center">{{ producto.cantidad_vendida }}</td>
                        <td>${{ "{:,.2f}".format(producto.total_vendido) }}</td>
                        <td class="text-success">${{ "{:,.2f}".format(producto.ganancia_unitaria_promedio) }}</td>
                        <td class="ganancia-col">${{ "{:,.2f}".format(producto.ganancia_total) }}</td>
                        <td class="text-info">{{ "{:.1f}".format(producto.margen_porcentaje) }}%</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="8" class="text-center">No hay datos de ventas para el per√≠odo seleccionado</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <!-- Todos los Productos -->
    {% if productos_rentables|length > 10 %}
    <div class="table-card">
        <h3>üìä Todos los Productos ({{ productos_rentables|length }})</h3>
        <div class="table-responsive">
            <table class="table">
                <thead>
                    <tr>
                        <th>Posici√≥n</th>
                        <th>Producto</th>
                        <th>Categor√≠a</th>
                        <th>Unidades</th>
                        <th>Total Vendido</th>
                        <th>Ganancia Total</th>
                        <th>% Margen</th>
                    </tr>
                </thead>
                <tbody>
                    {% for producto in productos_rentables %}
                    <tr>
                        <td class="text-center">{{ loop.index }}</td>
                        <td>{{ producto.nombre }}</td>
                        <td>{{ producto.categoria }}</td>
                        <td class="text-center">{{ producto.cantidad_vendida }}</td>
                        <td>${{ "{:,.2f}".format(producto.total_vendido) }}</td>
                        <td class="text-success">${{ "{:,.2f}".format(producto.ganancia_total) }}</td>
                        <td>{{ "{:.1f}".format(producto.margen_porcentaje) }}%</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% endif %}

    <!-- An√°lisis por Categor√≠a -->
    <div class="table-card">
        <h3>üìÇ Rentabilidad por Categor√≠a</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Categor√≠a</th>
                    <th>Productos</th>
                    <th>Unidades Vendidas</th>
                    <th>Ganancia Total</th>
                    <th>Ganancia Promedio</th>
                </tr>
            </thead>
            <tbody>
                {% if rentabilidad_categorias %}
                    {% for cat in rentabilidad_categorias %}
                    <tr>
                        <td><strong>{{ cat.categoria }}</strong></td>
                        <td class="text-center">{{ cat.num_productos }}</td>
                        <td class="text-center">{{ cat.unidades_vendidas }}</td>
                        <td class="ganancia-col">${{ "{:,.2f}".format(cat.ganancia_total) }}</td>
                        <td class="text-success">${{ "{:,.2f}".format(cat.ganancia_promedio) }}</td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="5" class="text-center">No hay datos disponibles</td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<style>
.filter-section {
    background: white;
    padding: 20px;
    border-radius: 10px;
    margin: 20px 0;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
}

.filter-form {
    display: flex;
    gap: 15px;
    align-items: end;
    flex-wrap: wrap;
}

.filter-group {
    flex: 1;
    min-width: 200px;
}

.filter-group label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
    color: #555;
}

.summary-cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin: 20px 0;
}

.summary-card {
    background: white;
    border-radius: 10px;
    padding: 25px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    align-items: center;
    gap: 20px;
    transition: transform 0.2s;
}

.summary-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
}

.summary-card.green {
    border-left: 5px solid #27ae60;
}

.summary-card.blue {
    border-left: 5px solid #3498db;
}

.summary-card.orange {
    border-left: 5px solid #f39c12;
}

.summary-icon {
    font-size: 50px;
    width: 80px;
    height: 80px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f8f9fa;
    border-radius: 10px;
}

.summary-content h3 {
    margin: 0 0 5px 0;
    font-size: 14px;
    color: #666;
    font-weight: 600;
}

.summary-content p {
    margin: 0;
    font-size: 28px;
    font-weight: 700;
    color: #2c3e50;
}

.table-card {
    background: white;
    border-radius: 10px;
    padding: 25px;
    margin: 20px 0;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.table-card h3 {
    margin-top: 0;
    color: #2c3e50;
    border-bottom: 2px solid #27ae60;
    padding-bottom: 10px;
}

.table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
}

.table thead {
    background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
    color: white;
}

.table th {
    padding: 15px;
    text-align: left;
    font-weight: 600;
}

.table td {
    padding: 12px 15px;
    border-bottom: 1px solid #eee;
}

.table tbody tr:hover {
    background: #e8f8f5;
}

.top-product {
    background: #fff9e6 !important;
    font-weight: 600;
}

.rank {
    font-size: 20px;
    text-align: center;
    width: 60px;
}

.text-center {
    text-align: center;
}

.text-success {
    color: #27ae60;
    font-weight: 600;
}

.text-info {
    color: #3498db;
    font-weight: 600;
}

.ganancia-col {
    color: #27ae60;
    font-weight: 700;
    font-size: 16px;
}

.table-responsive {
    overflow-x: auto;
}

.button-group {
    display: flex;
    gap: 10px;
}

.btn-success {
    background: #27ae60;
    color: white;
    padding: 10px 20px;
    border-radius: 5px;
    text-decoration: none;
    font-weight: 600;
    transition: background 0.3s;
}

.btn-success:hover {
    background: #229954;
}
</style>
{% endblock %}