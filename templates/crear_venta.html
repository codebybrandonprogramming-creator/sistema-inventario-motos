{% extends "base.html" %}
{% block title %}Registrar Venta{% endblock %}

{% block content %}
<style>
    /* Fondo con gradiente animado */
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }
    
    .venta-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 2rem;
    }
    
    .venta-header {
        text-align: center;
        margin-bottom: 2rem;
        animation: fadeInDown 0.6s ease;
    }
    
    .venta-header h2 {
        color: #ffffff;
        font-size: 2.5rem;
        font-weight: 800;
        text-shadow: 0 4px 12px rgba(0,0,0,0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
    }
    
    .venta-header .icon-motor {
        font-size: 3rem;
        animation: rotate 3s linear infinite;
    }
    
    @keyframes rotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    
    /* Tarjeta con efecto glassmorphism */
    .glass-card {
        background: rgba(255, 255, 255, 0.15);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border-radius: 25px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        padding: 3rem;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: fadeInUp 0.8s ease;
    }
    
    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    /* Labels elegantes */
    .form-label-custom {
        color: #ffffff;
        font-weight: 700;
        font-size: 1.1rem;
        margin-bottom: 0.8rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .form-label-custom i {
        font-size: 1.3rem;
        color: #ffd700;
    }
    
    /* Input de búsqueda premium */
    .search-input {
        background: rgba(255, 255, 255, 0.95);
        border: 2px solid rgba(255, 255, 255, 0.5);
        border-radius: 15px;
        padding: 1rem 1.5rem;
        font-size: 1.1rem;
        font-weight: 600;
        color: #333;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .search-input:focus {
        outline: none;
        border-color: #ffd700;
        background: #ffffff;
        box-shadow: 0 6px 25px rgba(255, 215, 0, 0.3);
        transform: translateY(-2px);
    }
    
    .search-input::placeholder {
        color: #999;
        font-weight: 500;
    }
    
    /* Select mejorado */
    .select-productos {
        background: rgba(255, 255, 255, 0.95);
        border: 2px solid rgba(255, 255, 255, 0.5);
        border-radius: 15px;
        padding: 1rem;
        font-size: 1rem;
        font-weight: 600;
        color: #333;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        transition: all 0.3s ease;
        cursor: pointer;
    }
    
    .select-productos:focus {
        outline: none;
        border-color: #ffd700;
        box-shadow: 0 6px 25px rgba(255, 215, 0, 0.3);
    }
    
    .select-productos option {
        padding: 10px;
        background: #ffffff;
        color: #333;
        font-weight: 600;
    }
    
    .select-productos option:hover {
        background: #f0f0f0;
    }
    
    /* Input de cantidad */
    .cantidad-input {
        background: rgba(255, 255, 255, 0.95);
        border: 2px solid rgba(255, 255, 255, 0.5);
        border-radius: 15px;
        padding: 1rem 1.5rem;
        font-size: 1.3rem;
        font-weight: 700;
        color: #333;
        text-align: center;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    }
    
    .cantidad-input:focus {
        outline: none;
        border-color: #00ff88;
        box-shadow: 0 6px 25px rgba(0, 255, 136, 0.3);
        transform: scale(1.05);
    }
    
    /* Display del total */
    .total-display {
        background: linear-gradient(135deg, #00ff88 0%, #00cc6a 100%);
        border: 3px solid #ffffff;
        border-radius: 20px;
        padding: 1.5rem;
        font-size: 2rem;
        font-weight: 900;
        color: #ffffff;
        text-align: center;
        text-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
        box-shadow: 0 8px 30px rgba(0, 255, 136, 0.4);
        animation: pulse 2s ease-in-out infinite;
        letter-spacing: 2px;
    }
    
    @keyframes pulse {
        0%, 100% {
            box-shadow: 0 8px 30px rgba(0, 255, 136, 0.4);
        }
        50% {
            box-shadow: 0 8px 40px rgba(0, 255, 136, 0.7);
        }
    }
    
    /* Botón premium */
    .btn-registrar {
        background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
        border: none;
        border-radius: 20px;
        padding: 1.2rem 3rem;
        font-size: 1.3rem;
        font-weight: 800;
        color: #333;
        text-transform: uppercase;
        letter-spacing: 2px;
        box-shadow: 0 10px 30px rgba(255, 215, 0, 0.5);
        transition: all 0.3s ease;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        margin: 2rem auto 0;
        width: 100%;
        max-width: 400px;
    }
    
    .btn-registrar:hover {
        transform: translateY(-5px) scale(1.05);
        box-shadow: 0 15px 40px rgba(255, 215, 0, 0.7);
        background: linear-gradient(135deg, #ffaa00 0%, #ffd700 100%);
    }
    
    .btn-registrar:active {
        transform: translateY(-2px) scale(1.02);
    }
    
    .btn-registrar i {
        font-size: 1.5rem;
    }
    
    /* Mensaje de ayuda */
    .help-text {
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.95rem;
        font-weight: 500;
        margin-top: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
    }
    
    /* Espaciado entre campos */
    .form-group-custom {
        margin-bottom: 2rem;
    }
    
    /* Badge decorativo */
    .badge-premium {
        display: inline-block;
        background: rgba(255, 215, 0, 0.2);
        color: #ffd700;
        padding: 0.3rem 1rem;
        border-radius: 20px;
        font-size: 0.9rem;
        font-weight: 700;
        border: 1px solid rgba(255, 215, 0, 0.5);
        margin-top: 0.5rem;
    }
</style>

<div class="venta-container">
    <div class="venta-header">
        <h2>
            <i class="bi bi-gear-fill icon-motor"></i>
            Registrar Venta
            <i class="bi bi-tools"></i>
        </h2>
    </div>

    <div class="glass-card">
        <form method="POST" id="formVenta">

            <div class="form-group-custom">
                <label class="form-label-custom">
                    <i class="bi bi-search"></i>
                    Buscar Producto
                </label>
                <input type="text" 
                       id="buscarProducto" 
                       class="form-control search-input" 
                       placeholder=" Escribe el nombre del repuesto..."
                       autocomplete="off">
                <div class="help-text">
                    <i class="bi bi-info-circle"></i>
                    Escribe para filtrar o selecciona directamente de la lista
                </div>
            </div>

            <div class="form-group-custom">
                <label class="form-label-custom">
                    <i class="bi bi-box-seam"></i>
                    Producto Seleccionado
                </label>
                <select name="producto_id" 
                        id="producto_id" 
                        class="form-select select-productos" 
                        size="6" 
                        required>
                    <option value="">-- Seleccione un producto --</option>
                    {% for p in productos %}
                    <option value="{{ p.id }}" 
                            data-precio="{{ p.precio_unitario }}" 
                            data-stock="{{ p.stock }}"
                            data-nombre="{{ p.nombre|lower }}">
                        {{ p.nombre }} (Stock: {{ p.stock }}) - ${{ "{:,.0f}".format(p.precio_unitario) }} COP
                    </option>
                    {% endfor %}
                </select>
                <span class="badge-premium"> Repuestos Premium</span>
            </div>

            <div class="form-group-custom">
                <label class="form-label-custom">
                    <i class="bi bi-hash"></i>
                    Cantidad
                </label>
                <input type="number" 
                       name="cantidad" 
                       id="cantidad" 
                       class="form-control cantidad-input" 
                       min="1" 
                       placeholder="0"
                       required>
            </div>

            <div class="form-group-custom">
                <label class="form-label-custom">
                    <i class="bi bi-cash-coin"></i>
                    Total a Pagar
                </label>
                <input type="text" 
                       id="total" 
                       class="form-control total-display" 
                       readonly 
                       placeholder="$0">
            </div>

            <button type="submit" class="btn btn-registrar">
                <i class="bi bi-check-circle-fill"></i>
                Registrar Venta
                <i class="bi bi-arrow-right-circle-fill"></i>
            </button>

        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const buscarInput = document.getElementById('buscarProducto');
    const selectProducto = document.getElementById('producto_id');
    const inputCantidad = document.getElementById('cantidad');
    const inputTotal = document.getElementById('total');
    
    const todasLasOpciones = Array.from(selectProducto.options);
    
    // FUNCIÓN 1: FILTRAR PRODUCTOS
    buscarInput.addEventListener('input', function() {
        const textoBusqueda = this.value.toLowerCase().trim();
        
        selectProducto.innerHTML = '';
        
        const opcionesFiltradas = todasLasOpciones.filter(function(opcion) {
            if (opcion.value === '') return true;
            const nombreProducto = opcion.getAttribute('data-nombre');
            return nombreProducto.includes(textoBusqueda);
        });
        
        opcionesFiltradas.forEach(function(opcion) {
            selectProducto.appendChild(opcion.cloneNode(true));
        });
        
        if (opcionesFiltradas.length === 1) {
            const sinResultados = document.createElement('option');
            sinResultados.textContent = ' No se encontraron productos';
            sinResultados.disabled = true;
            selectProducto.appendChild(sinResultados);
        }
    });
    
    // FUNCIÓN 2: CALCULAR TOTAL
    function calcularTotal() {
        const opcionSeleccionada = selectProducto.options[selectProducto.selectedIndex];
        
        if (!opcionSeleccionada || opcionSeleccionada.value === '') {
            inputTotal.value = '';
            inputTotal.placeholder = '$0';
            return;
        }
        
        const precio = parseFloat(opcionSeleccionada.getAttribute('data-precio')) || 0;
        const cantidad = parseInt(inputCantidad.value) || 0;
        const stockDisponible = parseInt(opcionSeleccionada.getAttribute('data-stock')) || 0;
        
        if (cantidad > stockDisponible && stockDisponible > 0 && cantidad > 0) {
            alert(' Solo hay ' + stockDisponible + ' unidades disponibles.');
            inputCantidad.value = stockDisponible;
            return calcularTotal();
        }
        
        const total = precio * cantidad;
        
        if (total > 0) {
            inputTotal.value = '$' + total.toLocaleString('es-CO', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }) + ' COP';
        } else {
            inputTotal.value = '';
            inputTotal.placeholder = '$0';
        }
    }
    
    // EVENTOS
    selectProducto.addEventListener('change', function() {
        const opcionSeleccionada = this.options[this.selectedIndex];
        if (opcionSeleccionada && opcionSeleccionada.value !== '') {
            const nombreProducto = opcionSeleccionada.text.split(' (Stock:')[0];
            buscarInput.value = nombreProducto;
        }
        
        inputCantidad.value = '';
        inputTotal.value = '';
        inputTotal.placeholder = '$0';
        calcularTotal();
    });
    
    inputCantidad.addEventListener('input', calcularTotal);
    
    selectProducto.addEventListener('dblclick', function() {
        if (this.value) {
            inputCantidad.focus();
        }
    });
    
    console.log(' Sistema Premium inicializado');
});
</script>
{% endblock %}